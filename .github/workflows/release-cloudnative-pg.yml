name: Release CloudNativePG Component

on:
  push:
    tags:
      - 'cloudnative-pg-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'CloudNativePG version to release (e.g., 1.27.1)'
        required: true
        type: string

env:
  COMPONENT_NAME: cloudnative-pg
  OCM_VERSION: 0.18.0

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#cloudnative-pg-v}"  # Remove cloudnative-pg-v prefix
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building CloudNativePG component version: $VERSION"

      - name: Install OCM CLI
        run: |
          curl -sL https://github.com/open-component-model/ocm/releases/download/v${OCM_VERSION}/ocm-${OCM_VERSION}-linux-amd64.tar.gz | tar xz
          sudo mv ocm /usr/local/bin/
          ocm version

      - name: Verify component structure
        run: |
          cd ${{ env.COMPONENT_NAME }}

          # Check all required files exist
          test -f component-constructor.yaml || (echo "Missing component-constructor.yaml" && exit 1)
          test -f operator/cnpg-operator.yml || (echo "Missing operator manifest" && exit 1)
          test -f configs/minimal/cluster.yaml || (echo "Missing minimal config" && exit 1)
          test -f configs/production/cluster.yaml || (echo "Missing production config" && exit 1)
          test -f docs/HELM_CHART_CONFIG.md || (echo "Missing Helm chart docs" && exit 1)

          echo "✓ All required files present"

      - name: Update component version
        run: |
          cd ${{ env.COMPONENT_NAME }}
          sed -i "s/version:.*/version: ${{ steps.version.outputs.version }}/" component-constructor.yaml
          echo "Updated component version to ${{ steps.version.outputs.version }}"

      - name: Build OCM component
        run: |
          cd ${{ env.COMPONENT_NAME }}

          # Create Common Transport Archive
          ocm add componentversions --create --file ../cloudnative-pg-component.ctf component-constructor.yaml

          echo "✓ OCM component built successfully"
          ls -lh ../cloudnative-pg-component.ctf

      - name: Create offline package (tar.gz)
        run: |
          # Create offline package directory
          mkdir -p offline-package/${{ env.COMPONENT_NAME }}

          # Copy component archive
          cp cloudnative-pg-component.ctf offline-package/${{ env.COMPONENT_NAME }}/

          # Copy installation files and documentation
          cp -r ${{ env.COMPONENT_NAME }}/operator offline-package/${{ env.COMPONENT_NAME }}/
          cp -r ${{ env.COMPONENT_NAME }}/configs offline-package/${{ env.COMPONENT_NAME }}/
          cp -r ${{ env.COMPONENT_NAME }}/docs offline-package/${{ env.COMPONENT_NAME }}/
          cp ${{ env.COMPONENT_NAME }}/README.md offline-package/${{ env.COMPONENT_NAME }}/

          # Create installation script
          cat > offline-package/${{ env.COMPONENT_NAME }}/install.sh <<'INSTALL_EOF'
          #!/usr/bin/env bash
          set -euo pipefail

          echo "Installing CloudNativePG operator..."

          # Install operator
          kubectl apply --server-side -f operator/cnpg-operator.yml

          echo "Waiting for operator to be ready..."
          kubectl wait --for=condition=Available deployment/cnpg-controller-manager \
            -n cnpg-system --timeout=120s

          echo "✓ CloudNativePG operator installed successfully"
          echo ""
          echo "To deploy a PostgreSQL cluster, choose a configuration:"
          echo "  Minimal (dev/test):  kubectl apply -f configs/minimal/cluster.yaml"
          echo "  Production (HA):     kubectl apply -f configs/production/cluster.yaml"
          echo ""
          echo "For advanced configuration, see: docs/HELM_CHART_CONFIG.md"
          INSTALL_EOF

          chmod +x offline-package/${{ env.COMPONENT_NAME }}/install.sh

          # Create package tarball
          tar -czf cloudnative-pg-${{ steps.version.outputs.version }}-offline.tar.gz -C offline-package ${{ env.COMPONENT_NAME }}

          echo "✓ Offline package created"
          ls -lh cloudnative-pg-${{ steps.version.outputs.version }}-offline.tar.gz

      - name: Generate checksums
        run: |
          sha256sum cloudnative-pg-${{ steps.version.outputs.version }}-offline.tar.gz > cloudnative-pg-${{ steps.version.outputs.version }}-offline.tar.gz.sha256
          cat cloudnative-pg-${{ steps.version.outputs.version }}-offline.tar.gz.sha256

      - name: Create release notes
        run: |
          cat > release-notes.md <<EOF
          # CloudNativePG OCM Component v${{ steps.version.outputs.version }}

          This release packages CloudNativePG v${{ steps.version.outputs.version }} as an OCM (Open Component Model) component for air-gapped and offline deployments.

          ## What's Included

          - **CloudNativePG Operator** v${{ steps.version.outputs.version }}
            - Operator deployment manifests
            - Custom Resource Definitions (CRDs)
            - RBAC configuration

          - **Container Images**
            - \`ghcr.io/cloudnative-pg/cloudnative-pg:${{ steps.version.outputs.version }}\` (operator)
            - \`ghcr.io/cloudnative-pg/postgresql:17\` (PostgreSQL 17)
            - \`ghcr.io/cloudnative-pg/postgresql:16\` (PostgreSQL 16)
            - \`ghcr.io/cloudnative-pg/postgresql:15\` (PostgreSQL 15)

          - **Configurations**
            - Minimal configuration (single instance for dev/test)
            - Production HA configuration (3 replicas, backups, monitoring)

          - **Documentation**
            - Component README
            - Complete Helm chart configuration guide
            - Usage examples

          ## Features

          - ✅ High availability with streaming replication
          - ✅ Automated backups to S3/Azure/GCS
          - ✅ Point-in-Time Recovery (PITR)
          - ✅ Prometheus monitoring integration
          - ✅ PgBouncer connection pooling
          - ✅ Rolling updates and switchover
          - ✅ TLS encryption support
          - ✅ Volume snapshots

          ## Installation

          ### For Air-Gapped Environments

          1. Download the offline package:
             \`\`\`bash
             wget https://github.com/${{ github.repository }}/releases/download/cloudnative-pg-v${{ steps.version.outputs.version }}/cloudnative-pg-${{ steps.version.outputs.version }}-offline.tar.gz
             \`\`\`

          2. Verify checksum:
             \`\`\`bash
             sha256sum -c cloudnative-pg-${{ steps.version.outputs.version }}-offline.tar.gz.sha256
             \`\`\`

          3. Extract and install:
             \`\`\`bash
             tar -xzf cloudnative-pg-${{ steps.version.outputs.version }}-offline.tar.gz
             cd cloudnative-pg
             ./install.sh
             \`\`\`

          ### Using OCM CLI

          \`\`\`bash
          # Install OCM CLI from https://ocm.software/docs/cli-reference/install/

          # Transfer component to your registry
          ocm transfer ctf cloudnative-pg-component.ctf oci://your-registry/ocm-components

          # In air-gapped environment
          ocm transfer oci://your-registry/ocm-components ctf cloudnative-pg-airgapped.ctf
          \`\`\`

          ## Requirements

          - Kubernetes 1.24+
          - Storage class with dynamic provisioning
          - For production: S3-compatible object storage for backups

          ## Quick Start

          \`\`\`bash
          # Install operator
          kubectl apply --server-side -f operator/cnpg-operator.yml

          # Deploy minimal cluster
          kubectl apply -f configs/minimal/cluster.yaml

          # Get credentials
          kubectl get secret app-user-secret -n postgres -o jsonpath='{.data.username}' | base64 -d
          kubectl get secret app-user-secret -n postgres -o jsonpath='{.data.password}' | base64 -d

          # Connect
          kubectl port-forward -n postgres svc/postgres-minimal-rw 5432:5432
          psql postgresql://app:changeme@localhost:5432/app
          \`\`\`

          ## Advanced Configuration

          All Helm chart parameters can be customized. See \`docs/HELM_CHART_CONFIG.md\` in the package for:
          - Complete operator configuration options
          - Complete cluster configuration options
          - Production tuning examples
          - Backup configuration
          - Monitoring setup

          ## Documentation

          - [Component README](https://github.com/${{ github.repository }}/blob/main/cloudnative-pg/README.md)
          - [Official CloudNativePG Documentation](https://cloudnative-pg.io/documentation/)
          - [OCM Documentation](https://ocm.software/docs/)

          ## Checksums

          \`\`\`
          $(cat cloudnative-pg-${{ steps.version.outputs.version }}-offline.tar.gz.sha256)
          \`\`\`

          ## Support

          - Report issues: https://github.com/${{ github.repository }}/issues
          - CloudNativePG issues: https://github.com/cloudnative-pg/cloudnative-pg/issues
          - Slack: #cloudnativepg on Kubernetes Slack
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: cloudnative-pg-v${{ steps.version.outputs.version }}
          name: CloudNativePG v${{ steps.version.outputs.version }}
          body_path: release-notes.md
          files: |
            cloudnative-pg-${{ steps.version.outputs.version }}-offline.tar.gz
            cloudnative-pg-${{ steps.version.outputs.version }}-offline.tar.gz.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **CloudNativePG component v${{ steps.version.outputs.version }} released successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Offline package: \`cloudnative-pg-${{ steps.version.outputs.version }}-offline.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- Checksum: \`cloudnative-pg-${{ steps.version.outputs.version }}-offline.tar.gz.sha256\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release URL" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/tag/cloudnative-pg-v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
