name: Release Artifact Conduit Component

on:
  push:
    tags:
      - 'artifact-conduit-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Artifact Conduit version to release (e.g., 0.1.0)'
        required: true
        type: string

env:
  COMPONENT_NAME: artifact-conduit
  OCM_VERSION: 0.18.0

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#artifact-conduit-v}"  # Remove artifact-conduit-v prefix
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building Artifact Conduit component version: $VERSION"

      - name: Install OCM CLI
        run: |
          curl -sL https://github.com/open-component-model/ocm/releases/download/v${OCM_VERSION}/ocm-${OCM_VERSION}-linux-amd64.tar.gz | tar xz
          sudo mv ocm /usr/local/bin/
          ocm version

      - name: Verify component structure
        run: |
          cd ${{ env.COMPONENT_NAME }}

          # Check all required files exist
          test -f component-constructor.yaml || (echo "Missing component-constructor.yaml" && exit 1)
          test -f arc-0.1.0.tgz || (echo "Missing Helm chart tarball" && exit 1)
          test -f configs/minimal/values.yaml || (echo "Missing minimal config" && exit 1)
          test -f configs/production/values.yaml || (echo "Missing production config" && exit 1)
          test -f docs/HELM_CHART_CONFIG.md || (echo "Missing Helm chart docs" && exit 1)
          test -f bootstrap.yaml || (echo "Missing bootstrap.yaml" && exit 1)
          test -f rgd-template.yaml || (echo "Missing RGD template" && exit 1)

          echo "✓ All required files present"

      - name: Update component version
        run: |
          cd ${{ env.COMPONENT_NAME }}
          sed -i "s/version:.*/version: ${{ steps.version.outputs.version }}/" component-constructor.yaml
          echo "Updated component version to ${{ steps.version.outputs.version }}"

      - name: Build OCM component
        run: |
          cd ${{ env.COMPONENT_NAME }}

          # Create Common Transport Archive
          ocm add componentversions --create --file ../artifact-conduit-component.ctf component-constructor.yaml

          echo "✓ OCM component built successfully"
          ls -lh ../artifact-conduit-component.ctf

      - name: Create offline package (tar.gz)
        run: |
          # Create offline package directory
          mkdir -p offline-package/${{ env.COMPONENT_NAME }}

          # Copy component archive
          cp artifact-conduit-component.ctf offline-package/${{ env.COMPONENT_NAME }}/

          # Copy installation files and documentation
          cp ${{ env.COMPONENT_NAME }}/arc-0.1.0.tgz offline-package/${{ env.COMPONENT_NAME }}/
          cp -r ${{ env.COMPONENT_NAME }}/configs offline-package/${{ env.COMPONENT_NAME }}/
          cp -r ${{ env.COMPONENT_NAME }}/docs offline-package/${{ env.COMPONENT_NAME }}/
          cp -r ${{ env.COMPONENT_NAME }}/examples offline-package/${{ env.COMPONENT_NAME }}/
          cp ${{ env.COMPONENT_NAME }}/bootstrap.yaml offline-package/${{ env.COMPONENT_NAME }}/
          cp ${{ env.COMPONENT_NAME }}/README.md offline-package/${{ env.COMPONENT_NAME }}/

          # Create installation script
          cat > offline-package/${{ env.COMPONENT_NAME }}/install.sh <<'INSTALL_EOF'
          #!/usr/bin/env bash
          set -euo pipefail

          echo "Installing Artifact Conduit (ARC)..."
          echo ""

          # Check prerequisites
          echo "Checking prerequisites..."
          command -v kubectl >/dev/null 2>&1 || { echo "Error: kubectl is not installed"; exit 1; }
          command -v helm >/dev/null 2>&1 || { echo "Error: helm is not installed"; exit 1; }

          # Check if cert-manager is installed
          if ! kubectl get namespace cert-manager >/dev/null 2>&1; then
              echo ""
              echo "⚠ cert-manager is not installed"
              echo ""
              echo "Artifact Conduit requires cert-manager for certificate management."
              echo "Install cert-manager first:"
              echo "  kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml"
              echo ""
              exit 1
          fi

          echo "✓ Prerequisites met"
          echo ""

          # Install with Helm
          echo "Installing Artifact Conduit with Helm..."
          helm install artifact-conduit arc-0.1.0.tgz \
            --namespace arc-system \
            --create-namespace \
            --values configs/minimal/values.yaml \
            --wait

          echo ""
          echo "✓ Artifact Conduit installed successfully"
          echo ""
          echo "To deploy with KRO/OCM (recommended for production):"
          echo "  1. Edit bootstrap.yaml to configure your registry"
          echo "  2. kubectl apply -f bootstrap.yaml"
          echo ""
          echo "For production deployment:"
          echo "  helm upgrade artifact-conduit arc-0.1.0.tgz \\"
          echo "    --namespace arc-system \\"
          echo "    --values configs/production/values.yaml"
          echo ""
          echo "For advanced configuration, see: docs/HELM_CHART_CONFIG.md"
          echo ""
          echo "Note: Artifact Conduit requires Argo Workflows to be installed."
          echo "If not installed yet, run:"
          echo "  kubectl apply -n argo -f https://github.com/argoproj/argo-workflows/releases/latest/download/install.yaml"
          INSTALL_EOF

          chmod +x offline-package/${{ env.COMPONENT_NAME }}/install.sh

          # Create package tarball
          tar -czf artifact-conduit-${{ steps.version.outputs.version }}-offline.tar.gz -C offline-package ${{ env.COMPONENT_NAME }}

          echo "✓ Offline package created"
          ls -lh artifact-conduit-${{ steps.version.outputs.version }}-offline.tar.gz

      - name: Generate checksums
        run: |
          sha256sum artifact-conduit-${{ steps.version.outputs.version }}-offline.tar.gz > artifact-conduit-${{ steps.version.outputs.version }}-offline.tar.gz.sha256
          cat artifact-conduit-${{ steps.version.outputs.version }}-offline.tar.gz.sha256

      - name: Create release notes
        run: |
          cat > release-notes.md <<EOF
          # Artifact Conduit (ARC) OCM Component v${{ steps.version.outputs.version }}

          This release packages Artifact Conduit v${{ steps.version.outputs.version }} as an OCM (Open Component Model) component for air-gapped and offline deployments.

          ## ⚠️ Project Status

          **Artifact Conduit is an early-stage project (pre-release)**
          - Active development with 356+ commits
          - Not recommended for production without thorough testing
          - Apache-2.0 license

          ## What's Included

          - **Artifact Conduit Components**
            - API Server (extension API for custom resources)
            - Controller Manager (reconciles Orders and ArtifactWorkflows)
            - etcd (dedicated storage backend)

          - **Container Images**
            - \`ghcr.io/opendefensecloud/arc-apiserver:latest\`
            - \`ghcr.io/opendefensecloud/arc-controller-manager:latest\`
            - \`quay.io/coreos/etcd:v3.6.6\`

          - **Configurations**
            - Minimal configuration (single instance for dev/test)
            - Production HA configuration (3 replicas, monitoring enabled)

          - **KRO ResourceGraphDefinition**
            - Self-contained deployment with automatic image localization
            - Bootstrap configuration for OCM-based deployment

          - **Documentation**
            - Component README
            - Complete Helm chart configuration guide
            - Usage examples

          ## Features

          - ✅ Multi-source artifact procurement (OCI, Helm, S3, HTTP)
          - ✅ Security validation (malware scanning, CVE analysis, license verification)
          - ✅ Policy enforcement across security boundaries
          - ✅ Declarative Kubernetes-native configuration
          - ✅ Audit trails and attestation
          - ✅ Integration with Argo Workflows
          - ✅ High availability support

          ## Prerequisites

          **Required:**
          - Kubernetes 1.28+
          - Helm 3.8+
          - cert-manager (for TLS management)
          - Argo Workflows (for artifact processing)

          **Optional:**
          - KRO (Kubernetes Resource Orchestrator) for RGD-based deployment
          - OCM K8s Toolkit for OCM component management
          - Prometheus Operator for metrics collection

          ## Installation

          ### For Air-Gapped Environments

          1. Download the offline package:
             \`\`\`bash
             wget https://github.com/${{ github.repository }}/releases/download/artifact-conduit-v${{ steps.version.outputs.version }}/artifact-conduit-${{ steps.version.outputs.version }}-offline.tar.gz
             \`\`\`

          2. Verify checksum:
             \`\`\`bash
             sha256sum -c artifact-conduit-${{ steps.version.outputs.version }}-offline.tar.gz.sha256
             \`\`\`

          3. Extract and install:
             \`\`\`bash
             tar -xzf artifact-conduit-${{ steps.version.outputs.version }}-offline.tar.gz
             cd artifact-conduit
             ./install.sh
             \`\`\`

          ### Using OCM CLI

          \`\`\`bash
          # Install OCM CLI from https://ocm.software/docs/cli-reference/install/

          # Transfer component to your registry
          ocm transfer ctf artifact-conduit-component.ctf oci://your-registry/ocm-components --copy-resources

          # In air-gapped environment
          ocm transfer oci://your-registry/ocm-components oci://internal-registry/ocm-components --copy-resources
          \`\`\`

          ### Using KRO Bootstrap (Recommended)

          \`\`\`bash
          # Install prerequisites
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
          kubectl apply -f https://github.com/kro-run/kro/releases/latest/download/kro.yaml
          kubectl apply -f https://github.com/open-component-model/ocm-k8s-toolkit/releases/latest/download/install.yaml

          # Edit bootstrap.yaml with your registry URL
          # Apply bootstrap configuration
          kubectl apply -f bootstrap.yaml
          \`\`\`

          ## Quick Start

          \`\`\`bash
          # Install cert-manager
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml

          # Install Argo Workflows
          kubectl create namespace argo
          kubectl apply -n argo -f https://github.com/argoproj/argo-workflows/releases/latest/download/install.yaml

          # Install Artifact Conduit
          helm install artifact-conduit arc-0.1.0.tgz \
            --namespace arc-system \
            --create-namespace \
            --values configs/minimal/values.yaml

          # Verify installation
          kubectl get all -n arc-system
          \`\`\`

          ## Deployment Profiles

          ### Minimal (Development/Testing)
          - Single replica for each component
          - Minimal resources (50m CPU, 64Mi memory)
          - 1Gi etcd storage
          - Metrics disabled
          - Suitable for: Dev/test environments, resource-constrained scenarios

          ### Production (High Availability)
          - 3 replicas for each component with pod anti-affinity
          - Higher resources (250m-1000m CPU, 256Mi-512Mi memory)
          - 20Gi etcd storage (fast SSD recommended)
          - Metrics and Prometheus integration enabled
          - Leader election enabled
          - Suitable for: Production workloads, mission-critical deployments

          ## Documentation

          - [Component README](https://github.com/${{ github.repository }}/blob/main/artifact-conduit/README.md)
          - [Artifact Conduit Documentation](https://arc.opendefense.cloud)
          - [GitHub Repository](https://github.com/opendefensecloud/artifact-conduit)
          - [OCM Documentation](https://ocm.software/docs/)

          ## Checksums

          \`\`\`
          $(cat artifact-conduit-${{ steps.version.outputs.version }}-offline.tar.gz.sha256)
          \`\`\`

          ## Support

          - Report packaging issues: https://github.com/${{ github.repository }}/issues
          - Artifact Conduit issues: https://github.com/opendefensecloud/artifact-conduit/issues
          - OCM issues: https://github.com/open-component-model/ocm/issues
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: artifact-conduit-v${{ steps.version.outputs.version }}
          name: Artifact Conduit v${{ steps.version.outputs.version }}
          body_path: release-notes.md
          files: |
            artifact-conduit-${{ steps.version.outputs.version }}-offline.tar.gz
            artifact-conduit-${{ steps.version.outputs.version }}-offline.tar.gz.sha256
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Artifact Conduit component v${{ steps.version.outputs.version }} released successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ **Marked as prerelease** - Artifact Conduit is an early-stage project" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Offline package: \`artifact-conduit-${{ steps.version.outputs.version }}-offline.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- Checksum: \`artifact-conduit-${{ steps.version.outputs.version }}-offline.tar.gz.sha256\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release URL" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/tag/artifact-conduit-v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
